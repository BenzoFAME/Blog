<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        body { background:#fafafa; font-family:'Segoe UI', Roboto, Arial, sans-serif; }
        .logo-text { font-weight:700; font-size:28px; background:linear-gradient(45deg,#f58529,#dd2a7b,#8134af,#515bd4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .post-card { background:#fff; border:1px solid #dbdbdb; border-radius:10px; max-width:700px; margin:30px auto; overflow:hidden; }
        .post-content { padding:20px; }
        .btn-add { background:linear-gradient(45deg,#f58529,#dd2a7b,#8134af); color:#fff; border-radius:10px; border:none; }
        .comment-preview { font-size:14px; color:#555; margin-top:8px; }
        #like-btn { font-size:26px; background:none; border:none; cursor:pointer; }
        #like-btn.liked { color:#e1306c; transform:scale(1.15); }
        #like-count { margin-left:6px; font-weight:600; }
    </style>
</head>
<body>

<nav class="navbar navbar-light justify-content-between px-4 py-2">
    <a class="logo-text text-decoration-none" th:href="@{/}">EGOROV'S&nbsp;BLOG</a>

    <div class="d-flex align-items-center gap-2">

        <!-- ‚≠ê –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å -->
        <a th:if="${#authentication != null}"
           th:href="@{/profile}"
           class="btn btn-outline-secondary btn-sm">
            –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
        </a>

        <a th:if="${#authentication == null}" th:href="@{/login}" class="btn btn-sm btn-outline-secondary">–í–æ–π—Ç–∏</a>
        <a th:if="${#authentication == null}" th:href="@{/registration}" class="btn btn-sm btn-outline-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>

        <div th:if="${#authentication != null}" class="d-flex align-items-center gap-2">
            <span class="text-muted">–ü—Ä–∏–≤–µ—Ç, <strong th:text="${#authentication.name}">user</strong></span>
            <form th:action="@{/logout}" method="post" class="m-0">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-outline-danger btn-sm">–í—ã–π—Ç–∏</button>
            </form>
        </div>
    </div>
</nav>

<div class="post-card shadow-sm">

    <!-- carousel -->
    <div th:if="${post.images != null and !post.images.isEmpty()}">
        <div th:id="'carouselPost' + ${post.id}" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div th:each="image, iterStat : ${post.images}" class="carousel-item"
                     th:classappend="${iterStat.index == 0} ? ' active'">
                    <img th:src="@{'/images/' + ${image.id}}" class="d-block w-100" alt="image">
                </div>
            </div>
            <button class="carousel-control-prev" type="button"
                    th:attr="data-bs-target='#carouselPost' + ${post.id}"
                    data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button"
                    th:attr="data-bs-target='#carouselPost' + ${post.id}"
                    data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    </div>

    <div th:if="${post.images == null or post.images.isEmpty()}">
        <img th:if="${post.previewImageId != null}" th:src="@{'/images/' + ${post.previewImageId}}" class="w-100" alt="preview">
    </div>

    <div class="post-content">
        <h3 th:text="${post.title}"></h3>

        <!-- ‚≠ê –ê–≤—Ç–æ—Ä = —Å—Å—ã–ª–∫–∞ -->
        <p class="text-muted">
            –ê–≤—Ç–æ—Ä:
            <a th:if="${post.author != null}"
               th:href="@{'/profile/' + ${post.author.id}}"
               th:text="${post.author.username}"
               class="text-decoration-none fw-bold text-muted"></a>

            <span th:if="${post.author == null}">–ì–æ—Å—Ç—å</span>
        </p>

        <p th:text="${post.content}"></p>

        <!-- —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div class="mb-3">
            <a th:if="${#authentication != null and (#authentication.name == post.author.username or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
               th:href="@{'/posts/edit/' + ${post.id}}" class="btn btn-sm btn-outline-primary me-2">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>

            <form th:if="${#authentication != null and (#authentication.name == post.author.username or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
                  th:action="@{'/posts/delete/' + ${post.id}}" method="post" style="display:inline"
                  onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?');">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-sm btn-outline-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>

        <!-- –ª–∞–π–∫–∏ -->
        <div class="d-flex align-items-center">
            <button th:if="${#authentication != null}" id="like-btn" th:data-id="${post.id}" class="me-2">‚ù§Ô∏è</button>
            <a th:if="${#authentication == null}" th:href="@{/login}" class="me-2">‚ù§Ô∏è</a>
            <span id="like-count" th:text="${post.likes}">0</span>
        </div>
    </div>

    <!-- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="px-4 pb-4">

        <h5 class="mt-3 mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h5>

        <div th:each="comment : ${comments}" class="comment-preview border-bottom pb-2 mb-2">
            <!-- ‚≠ê –ê–≤—Ç–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è ‚Äî —Å—Å—ã–ª–∫–∞ -->
            <a th:if="${comment.author != null}"
               th:href="@{'/profile/' + ${comment.author.id}}"
               th:text="${comment.author.username}"
               class="fw-bold text-decoration-none text-dark"></a>

            <span th:if="${comment.author == null}">–ì–æ—Å—Ç—å</span>:
            <span th:text="${comment.text}"></span>
        </div>

        <!-- —Ñ–æ—Ä–º–∞ -->
        <div th:if="${#authentication != null}">
            <form th:action="@{'/comments/add/' + ${post.id}}" method="post" class="mt-3">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <textarea class="form-control mb-2" name="text" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                <button class="btn btn-add w-100" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>

        <div th:if="${#authentication == null}" class="mt-3">
            <a th:href="@{/login}" class="btn btn-outline-primary w-100">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</a>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    document.addEventListener("DOMContentLoaded", () => {
        const likeBtn = document.getElementById("like-btn");
        const likeCount = document.getElementById("like-count");
        if (!likeBtn) return;

        likeBtn.addEventListener("click", async () => {
            const postId = likeBtn.dataset.id;

            likeBtn.classList.toggle("liked");

            const resp = await fetch(`/posts/like/${postId}`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            });

            if (resp.ok) {
                likeCount.textContent = await resp.text();
            }
        });
    });
</script>

</body>
</html>

