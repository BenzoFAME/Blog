<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        body { background:#fafafa; font-family:'Segoe UI', Roboto, Arial, sans-serif; }
        .logo-text { font-weight:700; font-size:28px; background:linear-gradient(45deg,#f58529,#dd2a7b,#8134af,#515bd4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .post-card { background:#fff; border:1px solid #dbdbdb; border-radius:10px; max-width:700px; margin:30px auto; overflow:hidden; }
        .post-content { padding:20px; }
        .btn-add { background:linear-gradient(45deg,#f58529,#dd2a7b,#8134af); color:#fff; border-radius:10px; border:none; }
        .comment-preview { font-size:14px; color:#555; margin-top:8px; }
        #like-btn { font-size:26px; background:none; border:none; cursor:pointer; }
        #like-btn.liked { color:#e1306c; transform:scale(1.15); }
        #like-count { margin-left:6px; font-weight:600; }
    </style>
</head>
<body>

<nav class="navbar navbar-light justify-content-between px-4 py-2">
    <a class="logo-text text-decoration-none" th:href="@{/}">EGOROV'S&nbsp;BLOG</a>

    <div class="d-flex align-items-center gap-2">
        <a th:if="${#request.userPrincipal == null}" th:href="@{/login}" class="btn btn-sm btn-outline-secondary">–í–æ–π—Ç–∏</a>
        <a th:if="${#request.userPrincipal == null}" th:href="@{/registration}" class="btn btn-sm btn-outline-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>

        <div th:if="${#request.userPrincipal != null}" class="d-flex align-items-center gap-2">
            <span class="text-muted">–ü—Ä–∏–≤–µ—Ç, <strong th:text="${#request.userPrincipal.name}">user</strong></span>
            <form th:action="@{/logout}" method="post" class="m-0">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-outline-danger btn-sm">–í—ã–π—Ç–∏</button>
            </form>
        </div>
    </div>
</nav>

<div class="post-card shadow-sm">
    <!-- carousel -->
    <div th:if="${post.images != null and !post.images.isEmpty()}">
        <div th:id="'carouselPost' + ${post.id}" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div th:each="image, iterStat : ${post.images}" class="carousel-item" th:classappend="${iterStat.index == 0} ? ' active'">
                    <img th:src="@{'/images/' + ${image.id}}" class="d-block w-100" alt="image">
                </div>
            </div>
            <button class="carousel-control-prev" type="button" th:attr="data-bs-target='#carouselPost' + ${post.id}" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" th:attr="data-bs-target='#carouselPost' + ${post.id}" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    </div>

    <div th:if="${post.images == null or post.images.isEmpty()}">
        <img th:if="${post.previewImageId != null}" th:src="@{'/images/' + ${post.previewImageId}}" class="w-100" alt="preview">
    </div>

    <div class="post-content">
        <h3 th:text="${post.title}"></h3>
        <p class="text-muted" th:text="'–ê–≤—Ç–æ—Ä: ' + (${post.author != null ? post.author.username : '–ì–æ—Å—Ç—å'})"></p>
        <p th:text="${post.content}"></p>

        <!-- –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∞/–∞–¥–º–∏–Ω–∞ -->
        <div class="mb-3">
            <a th:if="${#request.userPrincipal != null and (#request.userPrincipal.name == post.author.username || #request.isUserInRole('ROLE_ADMIN'))}"
               th:href="@{'/posts/edit/' + ${post.id}}" class="btn btn-sm btn-outline-primary me-2">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>

            <form th:if="${#request.userPrincipal != null and (#request.userPrincipal.name == post.author.username || #request.isUserInRole('ROLE_ADMIN'))}"
                  th:action="@{'/posts/delete/' + ${post.id}}" method="post" style="display:inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?');">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-sm btn-outline-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>

        <!-- –ª–∞–π–∫–∏ -->
        <div class="d-flex align-items-center">
            <!-- –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –∫–Ω–æ–ø–∫–∞ AJAX -->
            <button th:if="${#request.userPrincipal != null}" id="like-btn" th:data-id="${post.id}" class="me-2">‚ù§Ô∏è</button>

            <!-- –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥–∏–Ω -->
            <a th:if="${#request.userPrincipal == null}" th:href="@{/login}" class="me-2">‚ù§Ô∏è</a>

            <span id="like-count" th:text="${post.likes}">0</span>
        </div>
    </div>

    <!-- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
    <div class="px-4 pb-4">
        <h5 class="mt-3 mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h5>

        <div th:if="${comments != null and !comments.isEmpty()}">
            <div th:each="comment : ${comments}" class="comment-preview border-bottom pb-2 mb-2">
                <strong th:text="${comment.author != null ? comment.author.username : '–ì–æ—Å—Ç—å'}"></strong>:
                <span th:text="${comment.text}"></span>
            </div>
        </div>

        <div th:if="${comments == null or comments.isEmpty()}">
            <p class="text-muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        </div>

        <!-- —Ñ–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
        <div th:if="${#request.userPrincipal != null}">
            <form th:action="@{'/comments/add/' + ${post.id}}" method="post" class="mt-3">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <textarea class="form-control mb-2" name="text" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                <button class="btn btn-add w-100" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>

        <div th:if="${#request.userPrincipal == null}" class="mt-3">
            <a th:href="@{/login}" class="btn btn-outline-primary w-100">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // CSRF –¥–ª—è AJAX
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    document.addEventListener("DOMContentLoaded", () => {
        const likeBtn = document.getElementById("like-btn");
        const likeCount = document.getElementById("like-count");
        if (!likeBtn) return;

        likeBtn.addEventListener("click", async () => {
            const postId = likeBtn.dataset.id;
            // toggle UI
            likeBtn.classList.toggle("liked");

            const resp = await fetch(`/posts/like/${postId}`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            });

            if (resp.ok) {
                const txt = await resp.text();
                likeCount.textContent = txt;
            } else if (resp.status === 401) {
                window.location = '/login';
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ");
            }
        });
    });
</script>
</body>
</html>

